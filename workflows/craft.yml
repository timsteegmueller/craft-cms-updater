# Diese GitHub Action fÃ¼hrt ein automatisiertes Update fÃ¼r Craft CMS durch.
# Dabei werden folgende Schritte ausgefÃ¼hrt:
# - AbhÃ¤ngigkeiten installieren
# - Datenbank-Backup Ã¼ber Craft CLI
# - Craft CMS Update
# - Composer-AbhÃ¤ngigkeiten aktualisieren
# - Health Check
# - Ã„nderungen committen und ein Pull Request erstellen (nur bei Ã„nderungen)

name: Automatisches Craft CMS Update

on:
    # ErmÃ¶glicht manuelles AuslÃ¶sen Ã¼ber die GitHub UI
    workflow_dispatch:

    # UnterstÃ¼tzt automatisiertes Triggern via repository_dispatch (z.B. Ã¼ber n8n)
    repository_dispatch:
        types: [run-backup-und-update]
        branches:
            - main

jobs:
    update:
        runs-on: ubuntu-latest # Verwende den neuesten Ubuntu-Runner

        steps:
            # ğŸ” Schritt 1: Repository auschecken (Quellcode holen)
            - name: Projekt auschecken
              uses: actions/checkout@v4

            # ğŸ› ï¸ Schritt 2: PHP + Composer einrichten
            - name: PHP und Composer installieren
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.2' # Stelle sicher, dass die PHP-Version zu Craft passt
                  extensions: mbstring, intl, zip, pdo_mysql # Notwendige PHP-Erweiterungen
                  tools: composer # Composer installieren

            # ğŸ“¦ Schritt 3: AbhÃ¤ngigkeiten installieren (aktueller Stand aus composer.lock)
            - name: Composer-AbhÃ¤ngigkeiten installieren
              run: composer install --no-interaction

            # ğŸ’¾ Schritt 4: Datenbank-Backup via Craft CLI
            - name: ğŸ’¾ Datenbank-Backup (Craft CLI)
              run: |
                  echo "Starte Craft-Backup..."
                  php craft db/backup ./my-backups/ || (echo "âŒ Backup fehlgeschlagen" && exit 1)

            # ğŸ”„ Schritt 5: Craft CMS Update ausfÃ¼hren (non-blocking Fehlerbehandlung)
            - name: â¬†ï¸ Craft CMS Update ausfÃ¼hren
              run: |
                  echo "Starte Craft Update..."
                  php craft update all || echo "âš ï¸ Fehler bei Craft Update (ignoriert fÃ¼r Testzwecke)"

            # ğŸ§± Schritt 6: Composer-AbhÃ¤ngigkeiten aktualisieren (Dependencies)
            - name: â¬†ï¸ Composer-AbhÃ¤ngigkeiten aktualisieren
              run: |
                  echo "Starte Composer Update..."
                  composer update --no-interaction

            - name: Health Check (optional)
              run: |
               echo "Starte Health Check auf ${{ env.HEALTH_CHECK_URL }}"
               curl -f ${{ env.HEALTH_CHECK_URL }} || (echo 'âŒ Health Check fehlgeschlagen' && exit 1)
              env:
               HEALTH_CHECK_URL: http://farbcode-base.test/cms/health.php

                
                
            # ğŸš€ Schritt 8: Ã„nderungen committen + PR erstellen (nur bei Ã„nderungen)
            - name: ğŸ“¤ Ã„nderungen committen und Pull Request erstellen
              uses: peter-evans/create-pull-request@v5
              with:
                  token: ${{ secrets.GITHUB_TOKEN }} # Automatische Authentifizierung
                  commit-message: "ğŸ“¦ Update Craft CMS AbhÃ¤ngigkeiten"
                  title: "â¬†ï¸ Automatisches Craft CMS Update"
                  body: |
                      Dieses Update wurde automatisch erstellt.
                      Bitte prÃ¼fe ob die Website nach dem Update fehlerfrei lÃ¤uft.
                  branch: update/craft
                  delete-branch: true
