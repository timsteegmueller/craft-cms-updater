name: craft-test-mini
on:
  workflow_dispatch:
    inputs:
      dry_run: {description: 'Nur anzeigen', type: boolean, default: false}
      skip_backup: {description: 'DB-Backup überspringen', type: boolean, default: true}
      prepare_pr: {description: 'PR erstellen', type: boolean, default: true}

permissions: {contents: write, pull-requests: write}

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: {fetch-depth: 0}

      - uses: shivammathur/setup-php@v2
        with: {php-version: '8.2', coverage: none, tools: composer}

      - name: Composer install (root)
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Composer install (craft)
        working-directory: ./craft
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Run update
        working-directory: ./craft
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "Dry run"; php craft update/info || echo "No info"; exit 0
          fi
          if [ "${{ inputs.skip_backup }}" != "true" ]; then
            mkdir -p ../backups
            php craft db/backup ../backups/db_$(date +%F_%H-%M-%S).sql || echo "Backup skipped"
          fi
          echo "Updating Craft (no DB required to proceed)"
          php craft update all --interactive=0 --backup=0 || echo "Craft update warnings"
          composer update --no-interaction --no-progress || echo "Composer update warnings"

      - name: Set PR meta
        run: echo "DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

      - name: Ensure change when no lock diff
        run: |
          if [ -z "$(git status --porcelain craft/composer.lock)" ]; then
            mkdir -p docs
            date -u +"%Y-%m-%dT%H:%M:%SZ" > docs/last-update.txt
            git add docs/last-update.txt
          fi

      - name: Ensure change
        run: |
          mkdir -p docs
          date -u +"%Y-%m-%dT%H:%M:%SZ" > docs/last-update.txt
      
      - name: Create PR
        if: ${{ inputs.prepare_pr || inputs.prepare_pr == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          # ohne add-paths: action nimmt alle Änderungen mit
          commit-message: "chore(update): Craft deps aktualisiert (${{ env.DATE }})"
          title: "Craft deps update ${{ env.DATE }}"
          branch: update/${{ env.DATE }}-${{ github.run_number }}
          labels: dependencies, craft-update

