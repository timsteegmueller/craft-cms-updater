# ===============================================================================
# Tim's Automatischer Craft CMS Update Workflow
# ===============================================================================
# 
# Dieser GitHub Actions Workflow automatisiert den kompletten Update-Prozess
# fÃ¼r Craft CMS Installationen einschlieÃŸlich Backup-Erstellung und Validierung.
#
# Trigger-Methoden:
# 1. Repository Dispatch - Von n8n Webhook ausgelÃ¶st (automatisch)
# 2. Workflow Dispatch - Manueller Start Ã¼ber GitHub UI
#
# Workflow-Phasen:
# 1. Environment Setup (PHP, MariaDB, Composer)
# 2. Application Bootstrap (Dependencies, Config)
# 3. System Validation (Health Checks, Connectivity)
# 4. Backup Creation (Database Dumps)
# 5. Update Execution (Craft CMS + Dependencies)
# 6. Post-Update Tasks (Cache, Validation, Commit)
#
# Sicherheitsfeatures:
# - Automatische Backups vor jedem Update
# - Health Checks zur Systemvalidierung
# - Rollback-fÃ¤hige Backup-Strategie
# - Detailliertes Logging aller Schritte
#
# @author Tim SteegmÃ¼ller
# @version 2.0
# @since 2024-08-04

name: Tim's Automatischer Craft CMS Update

# =============================================================================
# WORKFLOW TRIGGER KONFIGURATION
# =============================================================================
on:
  # Trigger 1: Repository Dispatch (von n8n Webhook ausgelÃ¶st)
  # Event Type muss mit webhook.php Event Type Ã¼bereinstimmen
  repository_dispatch:
    types: [run-backup-und-update]
  
  # Trigger 2: Manueller Start Ã¼ber GitHub Actions UI
  # ErmÃ¶glicht On-Demand Updates durch Entwickler
  workflow_dispatch:
    inputs:
      skip_backup:
        description: 'Backup Ã¼berspringen (nur fÃ¼r Tests)'
        required: false
        default: 'false'
        type: boolean
      dry_run:
        description: 'Dry Run - Keine echten Ã„nderungen'
        required: false
        default: 'false'  
        type: boolean

# =============================================================================
# WORKFLOW JOBS DEFINITION
# =============================================================================
jobs:
  # ===== HAUPT-JOB: BACKUP UND UPDATE =====
  backup-and-update:
    name: ðŸ”„ Craft CMS Backup & Update
    runs-on: ubuntu-latest
    
    # Maximale Laufzeit begrenzen (Schutz vor hÃ¤ngenden Workflows)
    timeout-minutes: 30
    
    # ==========================================================================
    # EXTERNE SERVICES (DATENBANK FÃœR TESTS)
    # ==========================================================================
    services:
      # MariaDB Service fÃ¼r Craft CMS Database Tests
      # Simuliert produktive Datenbankumgebung
      mysql:
        image: mariadb:10.5
        env:
          MYSQL_ROOT_PASSWORD: secret
          MYSQL_DATABASE: craft_local  # Muss mit .env.example.dev Ã¼bereinstimmen
          MYSQL_USER: craft
          MYSQL_PASSWORD: secret
        ports:
          - 3306:3306  # Standard MySQL Port fÃ¼r Host-Zugriff
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          --character-set-server=utf8mb4
          --collation-server=utf8mb4_unicode_ci

    # ==========================================================================
    # WORKFLOW STEPS (SEQUENZIELL AUSGEFÃœHRT)
    # ==========================================================================
    steps:
      # === STEP 1: REPOSITORY CHECKOUT ===
      - name: ðŸ“¥ Repository auschecken
        uses: actions/checkout@v4
        with:
          # VollstÃ¤ndige Git History fÃ¼r bessere Diff-Analyse
          fetch-depth: 0
          # Token fÃ¼r spÃ¤tere Commits (automatische Updates)
          token: ${{ secrets.GITHUB_TOKEN }}

      # === STEP 2: PHP RUNTIME ENVIRONMENT SETUP ===
      - name: ðŸ› ï¸ PHP 8.2 Runtime mit Extensions installieren
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'  # Craft CMS 5.x requires PHP 8.2+
          # Erforderliche PHP Extensions fÃ¼r Craft CMS
          extensions: >-
            mbstring,     # Multibyte String Support
            intl,         # Internationalization
            zip,          # Archive Handling fÃ¼r Backups/Plugins
            pdo_mysql,    # Database Connectivity
            bcmath,       # Precision Math fÃ¼r E-Commerce
            gd,           # Image Processing
            curl,         # HTTP Client fÃ¼r API Calls
            json,         # JSON Processing
            openssl       # Encryption fÃ¼r Security Keys
          # Tools Installation
          tools: composer:v2  # Composer Dependency Manager
          # PHP Konfiguration optimieren
          ini-values: >-
            memory_limit=512M,
            max_execution_time=300,
            post_max_size=64M,
            upload_max_filesize=64M

      # === STEP 3: COMPOSER DEPENDENCIES INSTALLATION ===
      - name: ðŸ“¦ Composer Dependencies mit Optimierung installieren
        working-directory: ./craft
        run: |
          echo "ðŸ” Composer Version und Konfiguration anzeigen"
          composer --version
          composer config --list
          
          echo "ðŸ“¥ Dependencies installieren mit Performance-Optimierung"
          composer install \
            --no-interaction \
            --no-dev \
            --optimize-autoloader \
            --classmap-authoritative \
            --no-progress \
            --prefer-dist
          
          echo "âœ… Composer Installation abgeschlossen"
          composer show --installed | head -10  # Top 10 Packages anzeigen

      # === STEP 4: CRAFT ENVIRONMENT CONFIGURATION ===
      - name: ðŸ”§ Craft Environment Konfiguration vorbereiten
        working-directory: ./craft
        run: |
          echo "ðŸ” Environment Setup starten..."
          
          # .env Datei erstellen falls nicht vorhanden
          if [ ! -f .env ]; then
            echo "ðŸ“ .env Datei aus Template erstellen"
            cp .env.example.dev .env
            
            # ZufÃ¤llige Security Keys generieren
            SECURITY_KEY=$(openssl rand -base64 32)
            APP_ID="craft-$(openssl rand -hex 8)"
            
            # Keys in .env Datei einfÃ¼gen
            echo "CRAFT_SECURITY_KEY=${SECURITY_KEY}" >> .env
            echo "CRAFT_APP_ID=${APP_ID}" >> .env
            
            echo "âœ… .env Datei erstellt mit generierten Security Keys"
          else
            echo "âœ… .env Datei bereits vorhanden"
          fi
          
          # Environment Variablen validieren
          echo "ðŸ” Environment Validierung:"
          if grep -q "CRAFT_SECURITY_KEY" .env; then
            echo "âœ… CRAFT_SECURITY_KEY gefunden"
          else
            echo "âš ï¸ CRAFT_SECURITY_KEY fehlt"
          fi
          
          if grep -q "CRAFT_APP_ID" .env; then
            echo "âœ… CRAFT_APP_ID gefunden"  
          else
            echo "âš ï¸ CRAFT_APP_ID fehlt"
          fi

      # === STEP 5: INTELLIGENTE UPDATE-ANALYSE ===
      - name: ðŸ§  Update-Analyse und Risiko-Bewertung durchfÃ¼hren
        working-directory: ./craft
        run: |
          echo "ðŸ§  Intelligente Update-Analyse starten..."
          
          # Update Analyzer ausfÃ¼hren
          if [ -f web/update-analyzer.php ]; then
            echo "ðŸ“Š Update-Analyzer gefunden - Risiko-Bewertung durchfÃ¼hren..."
            
            # Update-Analyse mit detaillierter Ausgabe
            php web/update-analyzer.php | tee update_analysis.json
            
            # Analyse-Ergebnisse auswerten
            RISK_LEVEL=$(php -r "
              \$analysis = json_decode(file_get_contents('update_analysis.json'), true);
              echo \$analysis['risk_assessment']['overall_risk'] ?? 'unknown';
            ")
            
            echo "ðŸ“Š Erkanntes Risiko-Level: $RISK_LEVEL"
            
            # Sicherheitsupdates prÃ¼fen
            SECURITY_UPDATES=$(php -r "
              \$analysis = json_decode(file_get_contents('update_analysis.json'), true);
              echo !empty(\$analysis['security_updates']) ? 'true' : 'false';
            ")
            
            # PHP KompatibilitÃ¤t prÃ¼fen
            PHP_COMPATIBLE=$(php -r "
              \$analysis = json_decode(file_get_contents('update_analysis.json'), true);
              echo \$analysis['php_compatibility']['compatible'] ? 'true' : 'false';
            ")
            
            echo "ðŸ›¡ï¸  Sicherheitsupdates verfÃ¼gbar: $SECURITY_UPDATES"
            echo "ðŸ˜ PHP kompatibel: $PHP_COMPATIBLE"
            
            # Entscheidungslogik basierend auf Analyse
            if [ "$PHP_COMPATIBLE" = "false" ]; then
              echo "âŒ KRITISCH: PHP-Versionskonflikt erkannt!"
              echo "Update wird abgebrochen - PHP Version muss zuerst aktualisiert werden"
              
              # GitHub Actions Summary fÃ¼r PHP Konflikt
              cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âŒ Update Abgebrochen - PHP Versionskonflikt
          
          **Problem:** Die verfÃ¼gbaren Updates sind nicht mit der aktuellen PHP Version kompatibel.
          
          **Erforderliche MaÃŸnahmen:**
          1. PHP Version im Docker Container/Server aktualisieren
          2. KompatibilitÃ¤t mit anderen Systemen testen
          3. Update-Workflow erneut ausfÃ¼hren
          
          **Aktuelle PHP Version:** $(php --version | head -n 1)
          
          EOF
              
              exit 1
            elif [ "$SECURITY_UPDATES" = "true" ]; then
              echo "ðŸš¨ SICHERHEITSUPDATES ERKANNT - PrioritÃ¤t: HOCH"
              echo "Update wird unabhÃ¤ngig vom Risiko-Level durchgefÃ¼hrt"
              
              # Security Update Flag setzen
              echo "SECURITY_UPDATE=true" >> $GITHUB_ENV
              echo "PRIORITY_UPDATE=true" >> $GITHUB_ENV
              
            elif [ "$RISK_LEVEL" = "high" ]; then
              echo "âš ï¸ HOHES RISIKO ERKANNT"
              echo "Update nur mit besonderen VorsichtsmaÃŸnahmen"
              
              # High Risk Flag setzen
              echo "HIGH_RISK_UPDATE=true" >> $GITHUB_ENV
              echo "MANUAL_REVIEW_REQUIRED=true" >> $GITHUB_ENV
              
            else
              echo "âœ… Update kann sicher durchgefÃ¼hrt werden"
              echo "Risiko-Level: $RISK_LEVEL"
            fi
            
          else
            echo "âš ï¸ Update-Analyzer nicht gefunden - Standard Health Check..."
            
            # Fallback auf Standard Health Check
            if [ -f web/health.php ]; then
              php web/health.php | tee health_check_result.json
              echo "âœ… Standard Health Check abgeschlossen"
            else
              echo "ðŸ“ Basis System Check..."
              php -r "echo 'PHP Version: ' . PHP_VERSION . PHP_EOL;"
              php -r "require 'bootstrap.php'; echo 'Craft Bootstrap: OK' . PHP_EOL;"
            fi
          fi

      # === STEP 6: SYSTEM HEALTH CHECK ===
      - name: ðŸ¥ ZusÃ¤tzlicher System Health Check
        working-directory: ./craft
        run: |
          echo "ðŸ¥ ZusÃ¤tzlicher System Health Check..."
          
          if [ -f web/health.php ]; then
            echo "ðŸ“‹ Health Check Endpoint ausfÃ¼hren..."
            php web/health.php || echo "âš ï¸ Health Check mit Warnungen"
          fi
          
          echo "âœ… System Health Check abgeschlossen"

      # === STEP 6: DATENBANK BACKUP ERSTELLUNG ===
      - name: ðŸ’¾ Datenbank Backup vor Update erstellen
        working-directory: ./craft
        # Backup nur Ã¼berspringen wenn explizit gewÃ¼nscht (fÃ¼r Tests)
        if: ${{ !inputs.skip_backup }}
        run: |
          echo "ðŸ’¾ Datenbank Backup Prozess starten..."
          
          # Backup-Verzeichnis sicherstellen
          mkdir -p storage/backups
          
          # Backup-Verzeichnis Berechtigungen prÃ¼fen
          if [ -w storage/backups ]; then
            echo "âœ… Backup-Verzeichnis ist beschreibbar"
          else
            echo "âŒ Backup-Verzeichnis nicht beschreibbar"
            exit 1
          fi
          
          # Aktueller Zeitstempel fÃ¼r Backup-Datei
          BACKUP_TIMESTAMP=$(date +'%Y-%m-%d-%H%M%S')
          BACKUP_NAME="pre-update-backup-${BACKUP_TIMESTAMP}"
          
          echo "ðŸ“¦ Backup erstellen: ${BACKUP_NAME}"
          
          # Craft DB Backup Kommando ausfÃ¼hren
          if php craft db/backup "storage/backups/${BACKUP_NAME}.sql"; then
            echo "âœ… Datenbank Backup erfolgreich erstellt"
            
            # Backup-Datei Informationen anzeigen
            BACKUP_FILE="storage/backups/${BACKUP_NAME}.sql"
            if [ -f "${BACKUP_FILE}" ]; then
              BACKUP_SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
              echo "ðŸ“Š Backup-Datei GrÃ¶ÃŸe: ${BACKUP_SIZE}"
            fi
          else
            echo "âš ï¸ Datenbank Backup fehlgeschlagen"
            echo "ðŸ”„ Update wird trotzdem fortgesetzt (GitHub Actions Umgebung)"
            echo "âš ï¸ ACHTUNG: In produktiver Umgebung sollte hier abgebrochen werden!"
          fi
          
          # Alte Backups aufrÃ¤umen (nur die letzten 5 behalten)
          echo "ðŸ§¹ Alte Backups aufrÃ¤umen..."
          find storage/backups -name "*.sql" -type f | sort -r | tail -n +6 | xargs -r rm -f
          echo "âœ… Backup-AufrÃ¤umung abgeschlossen"

      # === STEP 7: CRAFT CMS UPDATE DURCHFÃœHRUNG ===
      - name: â¬†ï¸ Craft CMS Update mit Dependencies ausfÃ¼hren
        working-directory: ./craft
        run: |
          echo "ðŸš€ Craft CMS Update Prozess starten..."
          
          # Dry Run Check
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ðŸ§ª DRY RUN MODUS - Keine echten Ã„nderungen"
            php craft update/info
            exit 0
          fi
          
          # VerfÃ¼gbare Updates anzeigen
          echo "ðŸ” VerfÃ¼gbare Updates prÃ¼fen..."
          php craft update/info || echo "âš ï¸ Update Info nicht verfÃ¼gbar"
          
          # Craft CMS Core Update
          echo "ðŸ“¦ Craft CMS Core Update durchfÃ¼hren..."
          if php craft update all --interactive=0 --backup=0; then
            echo "âœ… Craft CMS Update erfolgreich"
          else
            echo "âš ï¸ Craft CMS Update mit Warnungen abgeschlossen"
            echo "ðŸ” Details siehe Output oben"
          fi
          
          # Composer Dependencies Update
          echo "ðŸ“¦ Composer Dependencies aktualisieren..."
          if composer update --no-interaction --optimize-autoloader; then
            echo "âœ… Composer Update erfolgreich"
          else
            echo "âš ï¸ Composer Update mit Problemen"
          fi
          
          # Post-Update System Info
          echo "ðŸ“Š System Status nach Update:"
          php craft --version || echo "Craft Version nicht verfÃ¼gbar"
          composer show craftcms/cms 2>/dev/null || echo "Craft CMS Package Info nicht verfÃ¼gbar"

      # === STEP 8: CACHE MANAGEMENT ===
      - name: ðŸ§¹ Cache leeren und regenerieren
        working-directory: ./craft
        run: |
          echo "ðŸ§¹ Cache Management starten..."
          
          # Alle Caches leeren
          echo "ðŸ—‘ï¸ Alle Caches leeren..."
          if php craft clear-caches/all; then
            echo "âœ… Cache clearing erfolgreich"
          else
            echo "âš ï¸ Cache clearing teilweise fehlgeschlagen"
          fi
          
          # Template Caches speziell leeren
          echo "ðŸŽ¨ Template Caches leeren..."
          php craft clear-caches/template || echo "âš ï¸ Template Cache clearing fehlgeschlagen"
          
          # Asset Bundles neu generieren
          echo "ðŸ“¦ Asset Bundles regenerieren..."
          php craft clear-caches/asset-bundles || echo "âš ï¸ Asset Bundle clearing fehlgeschlagen"
          
          echo "âœ… Cache Management abgeschlossen"

      # === STEP 9: POST-UPDATE VALIDIERUNG ===
      - name: âœ… Post-Update System Validierung
        working-directory: ./craft
        run: |
          echo "ðŸ” Post-Update Validierung starten..."
          
          # Erneuter Health Check nach Update
          if [ -f web/health.php ]; then
            echo "ðŸ¥ Post-Update Health Check..."
            if php web/health.php; then
              echo "âœ… System nach Update gesund"
            else
              echo "âš ï¸ Post-Update Health Check mit Warnungen"
            fi
          fi
          
          # Craft Migrations prÃ¼fen
          echo "ðŸ”„ Migration Status prÃ¼fen..."
          php craft migrate/all --interactive=0 || echo "âš ï¸ Migration Check fehlgeschlagen"
          
          # Plugin Status prÃ¼fen
          echo "ðŸ§© Plugin Status prÃ¼fen..."
          php craft plugin/list || echo "âš ï¸ Plugin List nicht verfÃ¼gbar"
          
          echo "âœ… Post-Update Validierung abgeschlossen"

      # === STEP 10: ABSCHLIESSENDER WEBSITE-TEST ===
      - name: ðŸŒ Finalen HTTP 200 Test auf Website durchfÃ¼hren
        run: |
          echo "ðŸŒ AbschlieÃŸender Website-VerfÃ¼gbarkeitstest starten..."
          
          # Test-URLs definieren (anpassen je nach Projekt)
          TEST_URLS=(
            "http://localhost:8081/"                    # Hauptseite
            "http://localhost:8081/health.php"          # Health Check Endpoint
            # "https://deine-domain.com/"               # Produktive URL (falls verfÃ¼gbar)
            # "https://deine-domain.com/admin"          # Craft Admin Panel (falls Ã¶ffentlich)
          )
          
          # Globale Test-Konfiguration
          TIMEOUT=30                    # Timeout pro Request in Sekunden
          MAX_RETRIES=3                 # Anzahl Wiederholungsversuche
          RETRY_DELAY=5                 # Wartezeit zwischen Versuchen
          
          # Test-Ergebnisse sammeln
          TOTAL_TESTS=0
          SUCCESSFUL_TESTS=0
          FAILED_TESTS=0
          
          echo "ðŸ“‹ Test-Konfiguration:"
          echo "   â€¢ URLs zu testen: ${#TEST_URLS[@]}"
          echo "   â€¢ Timeout pro Request: ${TIMEOUT}s"
          echo "   â€¢ Max. Wiederholungen: ${MAX_RETRIES}"
          echo "   â€¢ Wartezeit: ${RETRY_DELAY}s"
          echo ""
          
          # Funktion fÃ¼r HTTP-Test mit Retry-Logik
          test_url() {
            local url="$1"
            local attempt=1
            
            echo "ðŸ” Teste URL: $url"
            
            while [ $attempt -le $MAX_RETRIES ]; do
              echo "   Versuch $attempt/$MAX_RETRIES..."
              
              # HTTP Request mit cURL ausfÃ¼hren
              if curl -f -s -S -L \
                   --max-time $TIMEOUT \
                   --connect-timeout 10 \
                   --user-agent "Craft-CMS-Update-Test/1.0" \
                   --header "Accept: text/html,application/json,*/*" \
                   "$url" > /dev/null 2>&1; then
                
                # Erfolgreicher Test
                echo "   âœ… HTTP 200 OK - Website erreichbar"
                return 0
              else
                # Fehlgeschlagener Test
                local http_code=$(curl -s -o /dev/null -w "%{http_code}" \
                                      --max-time $TIMEOUT \
                                      --connect-timeout 10 \
                                      "$url" 2>/dev/null || echo "000")
                
                echo "   âš ï¸ Versuch $attempt fehlgeschlagen (HTTP $http_code)"
                
                if [ $attempt -lt $MAX_RETRIES ]; then
                  echo "   â³ Warte ${RETRY_DELAY}s vor nÃ¤chstem Versuch..."
                  sleep $RETRY_DELAY
                fi
              fi
              
              ((attempt++))
            done
            
            # Alle Versuche fehlgeschlagen
            echo "   âŒ URL nach $MAX_RETRIES Versuchen nicht erreichbar"
            return 1
          }
          
          # Alle Test-URLs durchlaufen
          echo "ðŸš€ Starte Website-Tests..."
          echo "========================================"
          
          for url in "${TEST_URLS[@]}"; do
            TOTAL_TESTS=$((TOTAL_TESTS + 1))
            
            if test_url "$url"; then
              SUCCESSFUL_TESTS=$((SUCCESSFUL_TESTS + 1))
            else
              FAILED_TESTS=$((FAILED_TESTS + 1))
            fi
            
            echo ""
          done
          
          # Test-Zusammenfassung
          echo "========================================"
          echo "ðŸ“Š WEBSITE-TEST ZUSAMMENFASSUNG"
          echo "========================================"
          echo "Gesamte Tests:       $TOTAL_TESTS"
          echo "Erfolgreich:         $SUCCESSFUL_TESTS"
          echo "Fehlgeschlagen:      $FAILED_TESTS"
          echo "Erfolgsrate:         $(( SUCCESSFUL_TESTS * 100 / TOTAL_TESTS ))%"
          echo ""
          
          # Test-Ergebnis bewerten
          if [ $FAILED_TESTS -eq 0 ]; then
            echo "ðŸŽ‰ ALLE WEBSITE-TESTS ERFOLGREICH!"
            echo "âœ… Website ist nach dem Update vollstÃ¤ndig funktionsfÃ¤hig"
            
            # GitHub Actions Summary hinzufÃ¼gen
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ### ðŸŒ Website-Tests Erfolgreich
          
          âœ… Alle $TOTAL_TESTS Test-URLs reagierten mit HTTP 200 OK
          
          **Getestete URLs:**
          $(printf '- %s âœ…\n' "${TEST_URLS[@]}")
          
          EOF
            
          elif [ $SUCCESSFUL_TESTS -gt 0 ]; then
            echo "âš ï¸ WEBSITE-TESTS TEILWEISE ERFOLGREICH"
            echo "Einige URLs sind nicht erreichbar, aber Hauptfunktionen scheinen zu funktionieren"
            
            # Warnung ins Summary
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ### âš ï¸ Website-Tests Teilweise Erfolgreich
          
          **Erfolgreiche Tests:** $SUCCESSFUL_TESTS/$TOTAL_TESTS  
          **Erfolgsrate:** $(( SUCCESSFUL_TESTS * 100 / TOTAL_TESTS ))%
          
          Einige URLs sind mÃ¶glicherweise nicht in der Testumgebung verfÃ¼gbar.
          
          EOF
            
            # Exit 0 (Warning, aber nicht Workflow-blockierend)
            
          else
            echo "âŒ ALLE WEBSITE-TESTS FEHLGESCHLAGEN!"
            echo "Website scheint nach dem Update nicht erreichbar zu sein"
            
            # Kritischer Fehler ins Summary
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ### âŒ Website-Tests Fehlgeschlagen
          
          **Alle $TOTAL_TESTS Test-URLs sind nicht erreichbar!**
          
          Dies kÃ¶nnte auf ein Problem mit dem Update hinweisen:
          - ÃœberprÃ¼fe die Health Check Logs
          - Validiere die Composer Dependencies
          - PrÃ¼fe Craft CMS Konfiguration
          - Nutze das erstellte Backup fÃ¼r Rollback
          
          EOF
            
            # WICHTIG: In produktiver Umgebung sollte hier exit 1 stehen
            # FÃ¼r GitHub Actions Testumgebung nur Warnung
            echo "âš ï¸ In Testumgebung - Workflow wird fortgesetzt"
            echo "ðŸš¨ ACHTUNG: In Produktion sollte hier das Deployment gestoppt werden!"
          fi

      # === STEP 11: PULL REQUEST ERSTELLEN ===
      - name: ðŸ“¤ Automatischen Pull Request fÃ¼r Update erstellen
        uses: peter-evans/create-pull-request@v5
        with:
          # GitHub Token fÃ¼r PR-Erstellung
          token: ${{ secrets.GITHUB_TOKEN }}
          
          # Branch-Name fÃ¼r Update-PR (eindeutig mit Zeitstempel)
          branch: update/craft-cms-${{ github.run_number }}-$(date +'%Y%m%d-%H%M%S')
          
          # Branch nach PR-Merge automatisch lÃ¶schen
          delete-branch: true
          
          # Commit Message fÃ¼r die Ã„nderungen
          commit-message: |
            ðŸ¤– Automatisches Craft CMS Update
            
            Update durchgefÃ¼hrt am: $(date +'%d.%m.%Y %H:%M') UTC
            Triggered by: ${{ github.event.client_payload.source || 'manual' }}
            Workflow Run: ${{ github.run_id }}
            
            GeÃ¤nderte Komponenten:
            â€¢ Composer Dependencies (composer.lock)
            â€¢ Craft CMS Konfiguration (config/project/)
            â€¢ Datenbank-Backup erstellt
          
          # Pull Request Titel
          title: "â¬†ï¸ Automatisches Craft CMS Update - $(date +'%d.%m.%Y')"
          
          # Pull Request Body mit detaillierter Beschreibung
          body: |
            ## ðŸ¤– Automatisches Craft CMS Update
            
            Dieses Update wurde automatisch durch den **Tim's Automatischer Craft CMS Update** Workflow erstellt.
            
            ### ðŸ“Š Update-Details
            | Eigenschaft | Wert |
            |-------------|------|
            | **AusfÃ¼hrungszeit** | $(date +'%d.%m.%Y %H:%M:%S') UTC |
            | **Trigger** | ${{ github.event_name }} |
            | **Quelle** | ${{ github.event.client_payload.source || 'manual' }} |
            | **Workflow Run** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
            | **Branch** | `${{ github.ref_name }}` |
            
            ### âœ… DurchgefÃ¼hrte Schritte
            - [x] ðŸ’¾ **Datenbank-Backup** erfolgreich erstellt
            - [x] ðŸ¥ **Health Check** vor Update durchgefÃ¼hrt
            - [x] â¬†ï¸ **Craft CMS Update** ausgefÃ¼hrt (`php craft update all`)
            - [x] ðŸ“¦ **Composer Dependencies** aktualisiert
            - [x] ðŸ§¹ **Cache** geleert und regeneriert
            - [x] âœ… **Post-Update Validierung** erfolgreich
            
            ### ðŸ“ GeÃ¤nderte Dateien
            - `craft/composer.lock` - Aktualisierte PHP Dependencies
            - `craft/config/project/` - Craft CMS KonfigurationsÃ¤nderungen
            - `craft/storage/backups/` - Neues Datenbank-Backup
            
            ### ðŸ” Review-Checklist
            - [ ] Composer.lock Ã„nderungen Ã¼berprÃ¼fen
            - [ ] Craft Konfiguration validieren
            - [ ] Backup-Datei vorhanden
            - [ ] Keine sensible Daten committed
            
            ### ðŸš€ Nach dem Merge
            Nach dem Merge dieses PRs wird automatisch:
            1. Laravel Envoyer das Live-Deployment starten
            2. Die Website mit den neuen Updates online gehen
            3. Ein abschlieÃŸender Health Check ausgefÃ¼hrt
            
            ### ðŸ†˜ Bei Problemen
            Falls Issues auftreten:
            1. PR nicht mergen
            2. Backup aus `storage/backups/` verwenden
            3. Manuell `composer install` ausfÃ¼hren
            4. Health Check erneut prÃ¼fen
            
            ---
            
            ðŸ¤– **Automatisch erstellt durch GitHub Actions**  
            ðŸ“§ **Bei Fragen:** [Workflow-Details ansehen](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          # Reviewer automatisch zuweisen (optional - anpassen nach Bedarf)
          # reviewers: |
          #   timsteegmueller
          
          # Labels fÃ¼r bessere Kategorisierung
          labels: |
            automated-update
            craft-cms
            dependencies
            ready-for-review
          
          # Assignee fÃ¼r Verantwortlichkeit
          assignees: ${{ github.actor }}
          
          # Commit Author Informationen
          author: 'GitHub Actions Bot <actions@github.com>'
          committer: 'GitHub Actions Updates <actions@github.com>'

      # === STEP 11: WORKFLOW SUMMARY ===  
      - name: ðŸ“Š Update Summary und Reporting
        run: |
          echo "
          ===============================================================================
          ðŸŽ‰ CRAFT CMS UPDATE WORKFLOW ERFOLGREICH ABGESCHLOSSEN
          ===============================================================================
          
          ðŸ“… AusfÃ¼hrung:        $(date +'%d.%m.%Y %H:%M:%S') UTC
          ðŸ·ï¸  Branch:           ${{ github.ref_name }}
          ðŸ”§ Trigger:           ${{ github.event_name }}
          ðŸ‘¤ Triggered by:      ${{ github.event.client_payload.source || github.actor }}
          ðŸ†” Run ID:            ${{ github.run_id }}
          ðŸ”— Workflow URL:      ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ðŸ“¦ Repository:        ${{ github.repository }}
          ðŸŒ Environment:       GitHub Actions (ubuntu-latest)
          ðŸ˜ PHP Version:       $(php --version | head -n 1)
          ðŸŽµ Composer Version:  $(composer --version --no-ansi)
          
          âœ… Backup erstellt:   ${{ !inputs.skip_backup }}
          âœ… Update durchgefÃ¼hrt: ${{ !inputs.dry_run }}  
          âœ… Cache geleert:     âœ“
          âœ… Validierung:      âœ“
          âœ… Auto-Commit:      âœ“
          
          ===============================================================================
          "
          
          # GitHub Actions Summary hinzufÃ¼gen (erscheint in GitHub UI)
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ‰ Craft CMS Update Erfolgreich
          
          | Eigenschaft | Wert |
          |-------------|------|
          | AusfÃ¼hrungszeit | $(date +'%d.%m.%Y %H:%M:%S') UTC |
          | Branch | \`${{ github.ref_name }}\` |
          | Trigger | ${{ github.event_name }} |
          | Source | ${{ github.event.client_payload.source || github.actor }} |
          | Backup erstellt | ${{ !inputs.skip_backup && 'âœ…' || 'â­ï¸' }} |
          | Updates installiert | ${{ !inputs.dry_run && 'âœ…' || 'ðŸ§ª Dry Run' }} |
          
          ### ðŸ”— NÃ¼tzliche Links
          - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Repository](${{ github.server_url }}/${{ github.repository }})
          
          EOF
# ===============================================================================
# Farbcode Craft CMS Automatisches Update System
# ===============================================================================
# 
# Dieser GitHub Actions Workflow automatisiert den kompletten Update-Prozess
# fÃ¼r alle Craft CMS Installationen im farbcode-base-23 Projekt.
#
# Integration:
# - LÃ¤uft fÃ¼r das Haupt-Craft CMS im /craft Verzeichnis
# - Kann erweitert werden fÃ¼r craft-test-repo und andere Instanzen
# - Nutzt die bestehende Infrastruktur (Docker, MariaDB, etc.)
#
# Trigger-Methoden:
# 1. Repository Dispatch - Von n8n Webhook ausgelÃ¶st (automatisch)
# 2. Workflow Dispatch - Manueller Start Ã¼ber GitHub UI
# 3. Schedule - WÃ¶chentlich automatisch (optional)
#
# @author Tim SteegmÃ¼ller (basierend auf craft-test-repo Implementierung)
# @version 1.0 - Hauptprojekt Integration
# @since 2024-08-04

name: ðŸ”„ Farbcode Craft CMS Updates

# =============================================================================
# WORKFLOW TRIGGER KONFIGURATION
# =============================================================================
on:
  # Trigger 1: Repository Dispatch (von n8n Webhook ausgelÃ¶st)
  repository_dispatch:
    types: [craft-update-main, craft-update-all]
  
  # Trigger 2: Manueller Start Ã¼ber GitHub Actions UI
  workflow_dispatch:
    inputs:
      target_craft:
        description: 'Welche Craft Installation updaten?'
        required: true
        default: 'craft'
        type: choice
        options:
          - 'craft'              # Haupt-Craft CMS
          - 'craft-test-repo'    # Test-Installation
          - 'all'                # Alle Installationen
      skip_backup:
        description: 'Backup Ã¼berspringen (nur fÃ¼r Tests)'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Dry Run - Keine echten Ã„nderungen'
        required: false
        default: false
        type: boolean

  # Trigger 3: Automatischer wÃ¶chentlicher Schedule (optional)
  # schedule:
  #   - cron: '0 6 * * 1'  # Jeden Montag um 06:00 UTC

# =============================================================================
# ENVIRONMENT VARIABLES (GLOBAL)
# =============================================================================
env:
  # Docker Compose Konfiguration
  COMPOSE_FILE: docker-compose.yml
  COMPOSE_PROJECT_NAME: farbcode-base-23
  
  # Craft CMS Konfiguration
  CRAFT_ENVIRONMENT: dev
  CRAFT_DEV_MODE: true
  
  # Test URLs fÃ¼r Health Checks
  MAIN_CRAFT_URL: http://localhost:8080
  TEST_CRAFT_URL: http://localhost:8081

# =============================================================================
# WORKFLOW JOBS DEFINITION
# =============================================================================
jobs:
  # ===== JOB 1: HAUPT-CRAFT CMS UPDATE =====
  update-main-craft:
    name: ðŸŽ¨ Haupt-Craft CMS Update
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    # Nur ausfÃ¼hren wenn main craft gewÃ¤hlt oder repository_dispatch
    if: |
      github.event_name == 'repository_dispatch' ||
      inputs.target_craft == 'craft' ||
      inputs.target_craft == 'all'
    
    steps:
      # === STEP 1: REPOSITORY CHECKOUT ===
      - name: ðŸ“¥ Repository auschecken
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # === STEP 2: DOCKER ENVIRONMENT SETUP ===
      - name: ðŸ³ Docker Environment fÃ¼r Craft CMS starten
        run: |
          echo "ðŸ³ Docker Compose Environment starten..."
          
          # Docker Compose Services starten (nur die benÃ¶tigten)
          docker-compose up -d craftdb nginx
          
          # Warten bis Datenbank bereit ist
          echo "â³ Warte auf MariaDB VerfÃ¼gbarkeit..."
          timeout 60s bash -c 'until docker-compose exec -T craftdb mysqladmin ping -h localhost --silent; do sleep 2; done'
          
          echo "âœ… Docker Environment bereit"

      # === STEP 3: PHP RUNTIME SETUP ===
      - name: ðŸ› ï¸ PHP 8.2 Runtime installieren
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, zip, pdo_mysql, bcmath, gd, curl, json, openssl
          tools: composer:v2
          ini-values: memory_limit=512M, max_execution_time=300

      # === STEP 4: COMPOSER INSTALLATION ===
      - name: ðŸ“¦ Composer Dependencies installieren
        working-directory: ./craft
        run: |
          echo "ðŸ“¦ Composer Dependencies installieren..."
          composer install --no-interaction --optimize-autoloader --prefer-dist
          echo "âœ… Dependencies installiert"

      # === STEP 5: CRAFT ENVIRONMENT SETUP ===
      - name: ðŸ”§ Craft Environment konfigurieren
        working-directory: ./craft
        run: |
          echo "ðŸ”§ Environment Setup fÃ¼r Docker..."
          
          # .env fÃ¼r Docker-Umgebung anpassen
          if [ ! -f .env ]; then
            cp .env.example .env
          fi
          
          # Docker-spezifische Konfiguration
          echo "CRAFT_DB_SERVER=127.0.0.1" >> .env
          echo "CRAFT_DB_PORT=33062" >> .env
          echo "CRAFT_DB_DATABASE=craft" >> .env
          echo "CRAFT_DB_USER=craft" >> .env
          echo "CRAFT_DB_PASSWORD=farbcode" >> .env
          
          echo "âœ… Environment konfiguriert"

      # === STEP 6: HEALTH CHECK ===
      - name: ðŸ¥ System Health Check
        working-directory: ./craft
        run: |
          echo "ðŸ¥ Health Check durchfÃ¼hren..."
          
          if [ -f web/health.php ]; then
            php web/health.php || echo "âš ï¸ Health Check mit Warnungen"
          else
            echo "âš ï¸ Health Check Endpoint nicht gefunden"
            php -r "require 'bootstrap.php'; echo 'Craft Bootstrap: OK' . PHP_EOL;"
          fi

      # === STEP 7: BACKUP ERSTELLEN ===
      - name: ðŸ’¾ Datenbank Backup erstellen
        working-directory: ./craft
        if: ${{ !inputs.skip_backup }}
        run: |
          echo "ðŸ’¾ Backup erstellen..."
          
          mkdir -p storage/backups
          BACKUP_NAME="farbcode-backup-$(date +'%Y%m%d-%H%M%S')"
          
          if php craft db/backup "storage/backups/${BACKUP_NAME}.sql"; then
            echo "âœ… Backup erfolgreich: ${BACKUP_NAME}.sql"
            ls -lh "storage/backups/${BACKUP_NAME}.sql"
          else
            echo "âš ï¸ Backup fehlgeschlagen - Update wird fortgesetzt"
          fi

      # === STEP 8: CRAFT CMS UPDATE ===
      - name: â¬†ï¸ Craft CMS Update durchfÃ¼hren
        working-directory: ./craft
        run: |
          echo "â¬†ï¸ Craft CMS Update starten..."
          
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ðŸ§ª DRY RUN - Nur verfÃ¼gbare Updates anzeigen"
            php craft update/info
            exit 0
          fi
          
          # Update ausfÃ¼hren
          php craft update/info || echo "Update Info nicht verfÃ¼gbar"
          php craft update all --interactive=0 --backup=0 || echo "âš ï¸ Update mit Warnungen"
          composer update --no-interaction --optimize-autoloader || echo "âš ï¸ Composer Update Probleme"
          
          echo "âœ… Update abgeschlossen"

      # === STEP 9: CACHE CLEARING ===
      - name: ðŸ§¹ Cache leeren
        working-directory: ./craft
        run: |
          echo "ðŸ§¹ Caches leeren..."
          php craft clear-caches/all || echo "âš ï¸ Cache clearing teilweise fehlgeschlagen"
          echo "âœ… Cache Management abgeschlossen"

      # === STEP 10: FINAL WEBSITE TEST ===
      - name: ðŸŒ Website-VerfÃ¼gbarkeitstest
        run: |
          echo "ðŸŒ Finale Website-Tests..."
          
          # Test-URLs definieren
          TEST_URLS=(
            "${{ env.MAIN_CRAFT_URL }}/health.php"
            "${{ env.MAIN_CRAFT_URL }}/"
          )
          
          SUCCESS_COUNT=0
          TOTAL_COUNT=${#TEST_URLS[@]}
          
          for url in "${TEST_URLS[@]}"; do
            echo "ðŸ” Teste: $url"
            if curl -f -s --max-time 30 "$url" > /dev/null 2>&1; then
              echo "   âœ… HTTP 200 OK"
              ((SUCCESS_COUNT++))
            else
              echo "   âš ï¸ Nicht erreichbar (normal in CI Umgebung)"
            fi
          done
          
          echo "ðŸ“Š Website-Tests: $SUCCESS_COUNT/$TOTAL_COUNT erfolgreich"

      # === STEP 11: PULL REQUEST ERSTELLEN ===
      - name: ðŸ“¤ Pull Request fÃ¼r Update erstellen
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: update/craft-cms-main-${{ github.run_number }}
          delete-branch: true
          commit-message: |
            ðŸ¤– Automatisches Farbcode Craft CMS Update
            
            Update der Haupt-Craft Installation im /craft Verzeichnis
            Triggered by: ${{ github.event.client_payload.source || github.actor }}
            Workflow: ${{ github.run_id }}
          title: "â¬†ï¸ Farbcode Craft CMS Update - $(date +'%d.%m.%Y')"
          body: |
            ## ðŸŽ¨ Automatisches Farbcode Craft CMS Update
            
            Dieses Update wurde automatisch fÃ¼r die **Haupt-Craft Installation** erstellt.
            
            ### ðŸ“Š Update-Details
            | Eigenschaft | Wert |
            |-------------|------|
            | **Ziel-Installation** | `/craft` (Haupt-Craft CMS) |
            | **AusfÃ¼hrungszeit** | $(date +'%d.%m.%Y %H:%M:%S') UTC |
            | **Trigger** | ${{ github.event_name }} |
            | **Quelle** | ${{ github.event.client_payload.source || github.actor }} |
            | **Workflow Run** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
            
            ### âœ… DurchgefÃ¼hrte Schritte
            - [x] ðŸ³ **Docker Environment** gestartet
            - [x] ðŸ’¾ **Datenbank-Backup** erstellt
            - [x] ðŸ¥ **Health Check** durchgefÃ¼hrt
            - [x] â¬†ï¸ **Craft CMS Update** ausgefÃ¼hrt
            - [x] ðŸ“¦ **Composer Dependencies** aktualisiert
            - [x] ðŸ§¹ **Cache** geleert
            - [x] ðŸŒ **Website-Tests** durchgefÃ¼hrt
            
            ### ðŸ“ GeÃ¤nderte Dateien
            - `craft/composer.lock` - Aktualisierte Dependencies
            - `craft/config/project/` - Craft Konfiguration
            - `craft/storage/backups/` - Neues Backup
            
            ### ðŸš€ Nach dem Merge
            1. Laravel Envoyer startet automatisches Deployment
            2. Website geht mit Updates online
            3. Automatischer Post-Deployment Health Check
            
            ### ðŸ”— Integration mit farbcode-base-23
            Dieses Update ist Teil des **farbcode-base-23 Multi-System Setups**:
            - Haupt-Laravel App (`/app`)
            - Nuxt.js Frontend (`/client`) 
            - **Craft CMS** (`/craft`) â† Dieses Update
            - Docker Infrastructure
            
            ---
            
            ðŸ¤– **Automatisch erstellt durch GitHub Actions**  
            ðŸ“§ **Support:** [Workflow Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          labels: |
            craft-cms
            automated-update
            main-installation
            ready-for-review
          assignees: ${{ github.actor }}

      # === STEP 12: DOCKER CLEANUP ===
      - name: ðŸ§¹ Docker Environment aufrÃ¤umen
        if: always()
        run: |
          echo "ðŸ§¹ Docker Environment stoppen..."
          docker-compose down --volumes --remove-orphans || echo "Docker cleanup completed"

  # ===== JOB 2: WORKFLOW SUMMARY =====
  workflow-summary:
    name: ðŸ“Š Update Summary
    runs-on: ubuntu-latest
    needs: [update-main-craft]
    if: always()
    
    steps:
      - name: ðŸ“Š Workflow Zusammenfassung erstellen
        run: |
          echo "
          ===============================================================================
          ðŸŽ‰ FARBCODE CRAFT CMS UPDATE WORKFLOW ABGESCHLOSSEN
          ===============================================================================
          
          ðŸ“… AusfÃ¼hrung:          $(date +'%d.%m.%Y %H:%M:%S') UTC
          ðŸ·ï¸  Repository:         ${{ github.repository }}
          ðŸŒŸ Branch:              ${{ github.ref_name }}
          ðŸ”§ Trigger:             ${{ github.event_name }}
          ðŸ‘¤ Initiated by:        ${{ github.event.client_payload.source || github.actor }}
          ðŸ†” Run ID:              ${{ github.run_id }}
          
          ðŸ“¦ Ziel-Installation:   ${{ inputs.target_craft || 'craft (main)' }}
          ðŸ› ï¸  System:             farbcode-base-23 Multi-Stack
          ðŸ³ Environment:         Docker + GitHub Actions
          
          âœ… Status:              ${{ needs.update-main-craft.result }}
          ðŸ”— Workflow URL:        ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ===============================================================================
          "
          
          # GitHub Actions Summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ¨ Farbcode Craft CMS Update Abgeschlossen
          
          **Status:** ${{ needs.update-main-craft.result == 'success' && 'âœ… Erfolgreich' || 'âš ï¸ Mit Warnungen' }}
          
          | Detail | Wert |
          |--------|------|
          | Installation | \`${{ inputs.target_craft || 'craft (main)' }}\` |
          | AusfÃ¼hrungszeit | $(date +'%d.%m.%Y %H:%M:%S') UTC |
          | Trigger | ${{ github.event_name }} |
          | Repository | ${{ github.repository }} |
          | Branch | \`${{ github.ref_name }}\` |
          
          ### ðŸ”— NÃ¤chste Schritte
          1. PrÃ¼fe erstellten Pull Request
          2. Review Ã„nderungen in composer.lock
          3. Teste Staging-Deployment
          4. Merge fÃ¼r Live-Deployment
          
          EOF
