# ===============================================================================
# Farbcode Craft CMS Automatisches Update System
# ===============================================================================
# 
# Dieser GitHub Actions Workflow automatisiert den kompletten Update-Prozess
# fÃ¼r alle Craft CMS Installationen im farbcode-base-23 Projekt.
#
# Integration:
# - LÃ¤uft fÃ¼r das Haupt-Craft CMS im /craft Verzeichnis
# - Kann erweitert werden fÃ¼r craft-test-repo und andere Instanzen
# - Nutzt die bestehende Infrastruktur (Docker, MariaDB, etc.)
#
# Trigger-Methoden:
# 1. Repository Dispatch - Von n8n Webhook ausgelÃ¶st (automatisch)
# 2. Workflow Dispatch - Manueller Start Ã¼ber GitHub UI
# 3. Schedule - WÃ¶chentlich automatisch (optional)
#
# @author Tim SteegmÃ¼ller (basierend auf craft-test-repo Implementierung)
# @version 1.0 - Hauptprojekt Integration
# @since 2024-08-04

name: ðŸ”„ Farbcode Craft CMS Updates

# =============================================================================
# WORKFLOW TRIGGER KONFIGURATION
# =============================================================================
on:
  # Trigger 1: Repository Dispatch (von n8n Webhook ausgelÃ¶st)
  repository_dispatch:
    types: [craft-update-main, craft-update-all]
  
  # Trigger 2: Manueller Start Ã¼ber GitHub Actions UI
  workflow_dispatch:
    inputs:
      target_craft:
        description: 'Welche Craft Installation updaten?'
        required: true
        default: 'craft'
        type: choice
        options:
          - 'craft'              # Haupt-Craft CMS
          - 'craft-test-repo'    # Test-Installation
          - 'all'                # Alle Installationen
      skip_backup:
        description: 'Backup Ã¼berspringen (nur fÃ¼r Tests)'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Dry Run - Keine echten Ã„nderungen'
        required: false
        default: false
        type: boolean

  # Trigger 3: Automatischer wÃ¶chentlicher Schedule (optional)
  # schedule:
  #   - cron: '0 6 * * 1'  # Jeden Montag um 06:00 UTC

# =============================================================================
# ENVIRONMENT VARIABLES (GLOBAL)
# =============================================================================
env:
  # Docker Compose Konfiguration
  COMPOSE_FILE: docker-compose.yml
  COMPOSE_PROJECT_NAME: farbcode-base-23
  
  # Craft CMS Konfiguration
  CRAFT_ENVIRONMENT: dev
  CRAFT_DEV_MODE: true
  
  # Test URLs fÃ¼r Health Checks
  MAIN_CRAFT_URL: http://localhost:8080
  TEST_CRAFT_URL: http://localhost:8081

# =============================================================================
# WORKFLOW JOBS DEFINITION
# =============================================================================
jobs:
  # ===== JOB 1: HAUPT-CRAFT CMS UPDATE =====
  update-main-craft:
    name: ðŸŽ¨ Haupt-Craft CMS Update
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    # Nur ausfÃ¼hren wenn main craft gewÃ¤hlt oder repository_dispatch
    if: |
      github.event_name == 'repository_dispatch' ||
      inputs.target_craft == 'craft' ||
      inputs.target_craft == 'all'
    
    steps:
      # === STEP 1: REPOSITORY CHECKOUT ===
      - name: ðŸ“¥ Repository auschecken
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # === STEP 2: DOCKER ENVIRONMENT SETUP ===
      - name: ðŸ³ Docker Environment fÃ¼r Craft CMS starten
        run: |
          echo "ðŸ³ Docker Compose Environment starten..."
          
          # Docker Compose Services starten (nur die benÃ¶tigten)
          docker-compose up -d craftdb nginx
          
          # Warten bis Datenbank bereit ist
          echo "â³ Warte auf MariaDB VerfÃ¼gbarkeit..."
          timeout 60s bash -c 'until docker-compose exec -T craftdb mysqladmin ping -h localhost --silent; do sleep 2; done'
          
          echo "âœ… Docker Environment bereit"

      # === STEP 3: PHP RUNTIME SETUP ===
      - name: ðŸ› ï¸ PHP 8.2 Runtime installieren
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, zip, pdo_mysql, bcmath, gd, curl, json, openssl
          tools: composer:v2
          ini-values: memory_limit=512M, max_execution_time=300

      # === STEP 4: COMPOSER INSTALLATION ===
      - name: ðŸ“¦ Composer Dependencies installieren
        working-directory: ./craft
        run: |
          echo "ðŸ“¦ Composer Dependencies installieren..."
          composer install --no-interaction --optimize-autoloader --prefer-dist
          echo "âœ… Dependencies installiert"

      # === STEP 5: CRAFT ENVIRONMENT SETUP ===
      - name: ðŸ”§ Craft Environment konfigurieren
        working-directory: ./craft
        run: |
          echo "ðŸ”§ Environment Setup fÃ¼r Docker..."
          
          # .env fÃ¼r Docker-Umgebung anpassen
          if [ ! -f .env ]; then
            cp .env.example .env
          fi
          
          # Docker-spezifische Konfiguration
          echo "CRAFT_DB_SERVER=127.0.0.1" >> .env
          echo "CRAFT_DB_PORT=33062" >> .env
          echo "CRAFT_DB_DATABASE=craft" >> .env
          echo "CRAFT_DB_USER=craft" >> .env
          echo "CRAFT_DB_PASSWORD=farbcode" >> .env
          
          echo "âœ… Environment konfiguriert"

      # === STEP 6: HEALTH CHECK ===
      - name: ðŸ¥ System Health Check
        working-directory: ./craft
        run: |
          echo "ðŸ¥ Health Check durchfÃ¼hren..."
          
          if [ -f web/health.php ]; then
            php web/health.php || echo "âš ï¸ Health Check mit Warnungen"
          else
            echo "âš ï¸ Health Check Endpoint nicht gefunden"
            php -r "require 'bootstrap.php'; echo 'Craft Bootstrap: OK' . PHP_EOL;"
          fi

      # === STEP 7: BACKUP ERSTELLEN ===
      - name: ðŸ’¾ Datenbank Backup erstellen
        working-directory: ./craft
        if: ${{ !inputs.skip_backup }}
        run: |
          echo "ðŸ’¾ Backup erstellen..."
          
          mkdir -p storage/backups
          BACKUP_NAME="farbcode-backup-$(date +'%Y%m%d-%H%M%S')"
          
          if php craft db/backup "storage/backups/${BACKUP_NAME}.sql"; then
            echo "âœ… Backup erfolgreich: ${BACKUP_NAME}.sql"
            ls -lh "storage/backups/${BACKUP_NAME}.sql"
          else
            echo "âš ï¸ Backup fehlgeschlagen - Update wird fortgesetzt"
          fi

      # === STEP 8: CRAFT CMS UPDATE ===
      - name: â¬†ï¸ Craft CMS Update durchfÃ¼hren
        working-directory: ./craft
        run: |
          echo "â¬†ï¸ Craft CMS Update starten..."
          
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ðŸ§ª DRY RUN - Nur verfÃ¼gbare Updates anzeigen"
            php craft update/info
            exit 0
          fi
          
          # Update ausfÃ¼hren
          php craft update/info || echo "Update Info nicht verfÃ¼gbar"
          php craft update all --interactive=0 --backup=0 || echo "âš ï¸ Update mit Warnungen"
          composer update --no-interaction --optimize-autoloader || echo "âš ï¸ Composer Update Probleme"
          
          echo "âœ… Update abgeschlossen"

      # === STEP 9: CACHE CLEARING ===
      - name: ðŸ§¹ Cache leeren
        working-directory: ./craft
        run: |
          echo "ðŸ§¹ Caches leeren..."
          php craft clear-caches/all || echo "âš ï¸ Cache clearing teilweise fehlgeschlagen"
          echo "âœ… Cache Management abgeschlossen"

      # === STEP 10: FINAL WEBSITE TEST ===
      - name: ðŸŒ Website-VerfÃ¼gbarkeitstest
        run: |
          echo "ðŸŒ Finale Website-Tests..."
          
          # Test-URLs definieren
          TEST_URLS=(
            "${{ env.MAIN_CRAFT_URL }}/health.php"
            "${{ env.MAIN_CRAFT_URL }}/"
          )
          
          SUCCESS_COUNT=0
          TOTAL_COUNT=${#TEST_URLS[@]}
          
          for url in "${TEST_URLS[@]}"; do
            echo "ðŸ” Teste: $url"
            if curl -f -s --max-time 30 "$url" > /dev/null 2>&1; then
              echo "   âœ… HTTP 200 OK"
              ((SUCCESS_COUNT++))
            else
              echo "   âš ï¸ Nicht erreichbar (normal in CI Umgebung)"
            fi
          done
          
          echo "ðŸ“Š Website-Tests: $SUCCESS_COUNT/$TOTAL_COUNT erfolgreich"

      # === STEP 11: PULL REQUEST ERSTELLEN ===
      - name: ðŸ“¤ Pull Request fÃ¼r Update erstellen
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: update/craft-cms-main-${{ github.run_number }}
          delete-branch: true
          commit-message: |
            ðŸ¤– Automatisches Farbcode Craft CMS Update
            
            Update der Haupt-Craft Installation im /craft Verzeichnis
            Triggered by: ${{ github.event.client_payload.source || github.actor }}
            Workflow: ${{ github.run_id }}
          title: "â¬†ï¸ Farbcode Craft CMS Update - $(date +'%d.%m.%Y')"
          body: |
            ## ðŸŽ¨ Automatisches Farbcode Craft CMS Update
            
            Dieses Update wurde automatisch fÃ¼r die **Haupt-Craft Installation** erstellt.
            
            ### ðŸ“Š Update-Details
            | Eigenschaft | Wert |
            |-------------|------|
            | **Ziel-Installation** | `/craft` (Haupt-Craft CMS) |
            | **AusfÃ¼hrungszeit** | $(date +'%d.%m.%Y %H:%M:%S') UTC |
            | **Trigger** | ${{ github.event_name }} |
            | **Quelle** | ${{ github.event.client_payload.source || github.actor }} |
            | **Workflow Run** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
            
            ### âœ… DurchgefÃ¼hrte Schritte
            - [x] ðŸ³ **Docker Environment** gestartet
            - [x] ðŸ’¾ **Datenbank-Backup** erstellt
            - [x] ðŸ¥ **Health Check** durchgefÃ¼hrt
            - [x] â¬†ï¸ **Craft CMS Update** ausgefÃ¼hrt
            - [x] ðŸ“¦ **Composer Dependencies** aktualisiert
            - [x] ðŸ§¹ **Cache** geleert
            - [x] ðŸŒ **Website-Tests** durchgefÃ¼hrt
            
            ### ðŸ“ GeÃ¤nderte Dateien
            - `craft/composer.lock` - Aktualisierte Dependencies
            - `craft/config/project/` - Craft Konfiguration
            - `craft/storage/backups/` - Neues Backup
            
            ### ðŸš€ Nach dem Merge
            1. Laravel Envoyer startet automatisches Deployment
            2. Website geht mit Updates online
            3. Automatischer Post-Deployment Health Check
            
            ### ðŸ”— Integration mit farbcode-base-23
            Dieses Update ist Teil des **farbcode-base-23 Multi-System Setups**:
            - Haupt-Laravel App (`/app`)
            - Nuxt.js Frontend (`/client`) 
            - **Craft CMS** (`/craft`) â† Dieses Update
            - Docker Infrastructure
            
            ---
            
            ðŸ¤– **Automatisch erstellt durch GitHub Actions**  
            ðŸ“§ **Support:** [Workflow Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          labels: |
            craft-cms
            automated-update
            main-installation
            ready-for-review
          assignees: ${{ github.actor }}

      # === STEP 12: DOCKER CLEANUP ===
      - name: ðŸ§¹ Docker Environment aufrÃ¤umen
        if: always()
        run: |
          echo "ðŸ§¹ Docker Environment stoppen..."
          docker-compose down --volumes --remove-orphans || echo "Docker cleanup completed"

  # ===== JOB 2: WORKFLOW SUMMARY =====
  workflow-summary:
    name: ðŸ“Š Update Summary
    runs-on: ubuntu-latest
    needs: [update-main-craft]
    if: always()
    
    steps:
      - name: ðŸ“Š Workflow Zusammenfassung erstellen
        run: |
          echo "
          ===============================================================================
          ðŸŽ‰ FARBCODE CRAFT CMS UPDATE WORKFLOW ABGESCHLOSSEN
          ===============================================================================
          
          ðŸ“… AusfÃ¼hrung:          $(date +'%d.%m.%Y %H:%M:%S') UTC
          ðŸ·ï¸  Repository:         ${{ github.repository }}
          ðŸŒŸ Branch:              ${{ github.ref_name }}
          ðŸ”§ Trigger:             ${{ github.event_name }}
          ðŸ‘¤ Initiated by:        ${{ github.event.client_payload.source || github.actor }}
          ðŸ†” Run ID:              ${{ github.run_id }}
          
          ðŸ“¦ Ziel-Installation:   ${{ inputs.target_craft || 'craft (main)' }}
          ðŸ› ï¸  System:             farbcode-base-23 Multi-Stack
          ðŸ³ Environment:         Docker + GitHub Actions
          
          âœ… Status:              ${{ needs.update-main-craft.result }}
          ðŸ”— Workflow URL:        ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ===============================================================================
          "
          
          # GitHub Actions Summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ¨ Farbcode Craft CMS Update Abgeschlossen
          
          **Status:** ${{ needs.update-main-craft.result == 'success' && 'âœ… Erfolgreich' || 'âš ï¸ Mit Warnungen' }}
          
          | Detail | Wert |
          |--------|------|
          | Installation | \`${{ inputs.target_craft || 'craft (main)' }}\` |
          | AusfÃ¼hrungszeit | $(date +'%d.%m.%Y %H:%M:%S') UTC |
          | Trigger | ${{ github.event_name }} |
          | Repository | ${{ github.repository }} |
          | Branch | \`${{ github.ref_name }}\` |
          
          ### ðŸ”— NÃ¤chste Schritte
          1. PrÃ¼fe erstellten Pull Request
          2. Review Ã„nderungen in composer.lock
          3. Teste Staging-Deployment
          4. Merge fÃ¼r Live-Deployment
          
          EOF
